
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Import Quips (CSV → JSON)</title>
    <style>
        body{margin:0;background:#0f1217;color:#e6e8ec;font:16px/1.5 system-ui,Segoe UI,Roboto}
        .wrap{max-width:820px;margin:40px auto;padding:0 16px}
        .card{background:#161b22;border:1px solid #232a34;border-radius:16px;padding:16px}
        .muted{color:#9aa4b2}
        .btn{display:inline-inline-block;border:1px solid #2a3342;border-radius:10px;padding:8px 12px;background:#121820;color:#e6e8ec;text-decoration:none;cursor:pointer}
        textarea{width:100%;min-height:220px;background:#0f1520;color:#e6e8ec;border:1px solid #2a3342;border-radius:8px;padding:10px}
        pre{white-space:pre-wrap;background:#0f1520;border:1px solid #2a3342;padding:10px;border-radius:8px}
        .sr-only{position:absolute!important;left:-10000px!important;top:auto!important;width:1px!important;height:1px!important;overflow:hidden!important;}
        .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        .spacer{height:8px}
    </style>
</head>
<body>
<div class="wrap">
    <h1>Import Bill Quips</h1>
    <p class="muted">Load your CSV from <code>/public/data/Bill_Cipher_Dialogue_Expanded.csv</code> (or paste below), then export a <code>quips.json</code> file.</p>

    <div class="card">
        <div class="row">
            <button class="btn" id="loadCsv" type="button">Load CSV from /public/data</button>

            <!-- Accessible label for file input -->
            <label for="csvFile" class="sr-only">Choose CSV file</label>
            <input type="file" id="csvFile" accept=".csv" style="display:none">

            <button class="btn" id="openPicker" type="button">Choose CSV…</button>
            <button class="btn" id="toJson" type="button">Convert → JSON</button>
            <button class="btn" id="download" type="button">Download quips.json</button>
            <a class="btn" href="/" role="button">Back to Mission Control</a>
        </div>

        <div class="spacer"></div>

        <!-- Accessible label for textarea -->
        <label for="csvArea" class="sr-only">CSV content</label>
        <textarea id="csvArea" placeholder="Paste CSV here..."></textarea>

        <h3>Preview JSON</h3>
        <pre id="jsonOut" aria-live="polite"></pre>
    </div>
</div>

<script>
    function parseCSV(csv){
      const rows=[]; let i=0, field='', row=[], inQ=false;
      while(i<csv.length){
        const ch = csv[i];
        if(ch === '"'){
          if(inQ && csv[i+1] === '"'){ field+='"'; i++; }
          else inQ = !inQ;
        }else if(ch === ',' && !inQ){
          row.push(field); field='';
        }else if((ch === '\n' || ch === '\r') && !inQ){
          if(field.length || row.length){ row.push(field); rows.push(row); row=[]; field=''; }
          if(ch === '\r' && csv[i+1] === '\n') i++;
        }else{
          field += ch;
        }
        i++;
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      return rows;
    }
    function csvToQuips(text){
      const rows = parseCSV(text);
      if(!rows.length) return [];
      const header = rows[0].map(h=>h.trim().toLowerCase());
      let idx = header.indexOf('text');
      if(idx === -1) idx = header.indexOf('quip');
      if(idx === -1) idx = header.length === 1 ? 0 : header.length-1;
      const out=[];
      for(let r=1; r<rows.length; r++){
        const cell = (rows[r][idx] ?? '').trim();
        if(cell) out.push({id: 'csv_'+r, text: cell});
      }
      return out;
    }
    function toJSONPayload(arr){ return { quips: arr }; }
    const $ = sel => document.querySelector(sel);

    $('#loadCsv').addEventListener('click', async ()=>{
      try{
        const res = await fetch('/public/data/Bill_Cipher_Dialogue_Expanded.csv', {cache:'no-store'});
        if(!res.ok) throw new Error('not found');
        $('#csvArea').value = await res.text();
      }catch(e){
        alert('Could not load CSV from /public/data. If running locally, start a server or paste the CSV manually.');
      }
    });
    $('#openPicker').addEventListener('click', ()=> $('#csvFile').click());
    $('#csvFile').addEventListener('change', ()=>{
      const f = $('#csvFile').files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ev => $('#csvArea').value = ev.target.result;
      reader.readAsText(f);
    });
    $('#toJson').addEventListener('click', ()=>{
      const arr = csvToQuips($('#csvArea').value);
      $('#jsonOut').textContent = JSON.stringify(toJSONPayload(arr), null, 2);
    });
    $('#download').addEventListener('click', ()=>{
      const txt = $('#jsonOut').textContent || JSON.stringify(toJSONPayload(csvToQuips($('#csvArea').value)), null, 2);
      const blob = new Blob([txt], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quips.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
</script>
</body>
</html>
